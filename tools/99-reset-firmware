#!/bin/sh
OLDDEVS=`ls /dev/tty.usbmodem* 2>/dev/null`
OLDDEVS2=`ls /dev/tty.usbmodem* 2>/dev/null`
echo "Please connect the PCB's USB cable to your computer and hit ENTER or RETURN"
read newline
sleep 2; # wait a few seconds to recognize the device
NEWDEVS=`ls /dev/tty.usbmodem* 2>/dev/null`
# we look at the old devices list twice to deal with
# the user unplugging the device when we tell them to plug it in
DEVICE=`echo "$OLDDEVS2\n$OLDDEVS\n$NEWDEVS"|sort |uniq -u`
if [`echo "$OLDDEVS"|wc -l` -gt `echo "$NEWDEVS"|wc -l` ]; then
    echo "ERROR: It seems like you unplugged something. Try again?";
#    exit -1;
fi

if [ "$OLDDEVS" == "$NEWDEVS" ]; then
    echo "ERROR: It seems like you didn't plug anything in.\nIf Step 2 ran ok, maybe our device detection is broken";
    exit -1;
fi

if [`echo "$DEVICE"|wc -l` -lt 1 ]; then
    echo "ERROR: Could not find the PCB device. If Step 2 ran ok, maybe our device detection is broken?\n";
    exit -1;
elif [ `echo "$DEVICE"|wc -l` -gt 1 ]; then 
    echo "ERROR: Multiple new usbserial devices appeared. Did you plug in two boards?\n";
    exit -1;
else
    echo "OK: We found the board. Time to flash firmware on $DEVICE";
fi


stty -f $DEVICE 1200
sleep 2
if ../binaries/mac/avrdude/avrdude -V -C../binaries/mac/avrdude/avrdude.conf -patmega32u4 -cavr109 -P$DEVICE -b57600 -D -Uflash:w:../firmware/noop.hex:i; then
    echo "OK: Flashing worked\nYou can start testing again\n";
    exit 0;
else 
    echo "ERROR: Flashing failed\n";
    exit -1;
fi
